<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Food Calci - Your Personal Food Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            background-image: url('background.jpg');
            background-repeat: no-repeat;
            background-size: cover;
            font-family: Arial, sans-serif;
            padding: 20px;
            color: #222;
        }
        h1 {
            margin-bottom: 0.5em;
        }
        label.upload-btn {
            background: cornflowerblue;
            border-radius: 4px;
            font-size: 14px;
            color: #fff;
            padding: 8px 12px;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 1em;
            user-select: none;
        }
        label.upload-btn:disabled,
        label.upload-btn[aria-disabled="true"] {
            background: gray;
            cursor: not-allowed;
        }
        #output {
            max-width: 250px;
            margin-bottom: 1em;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0,0,0,0.2);
        }
        #opResult {
            margin-top: 1em;
            font-size: 1rem;
        }
        table {
            border: 1px solid black;
            border-collapse: collapse;
            width: 100%;
            max-width: 350px;
            margin-top: 1em;
            background: rgba(255,255,255,0.9);
            border-radius: 6px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid black;
            padding: 6px 8px;
            text-align: left;
        }
        th {
            background: #ddd;
        }
        #calorie {
            font-weight: bold;
            font-size: 1.5em;
            color: #2a8;
        }
        #loadingSpinner {
            display: none;
            margin-left: 10px;
            vertical-align: middle;
            width: 20px;
            height: 20px;
            border: 3px solid #ccc;
            border-top: 3px solid cornflowerblue;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>FoodCalci - Your Personal Food Tracker</h1>

    <input type="file" id="fileToUpload" accept="image/*" aria-label="Upload food image" style="display:none" />
    <label for="fileToUpload" class="upload-btn" id="uploadLabel" tabindex="0">Upload Image</label>
    <span id="loadingSpinner" aria-live="polite" aria-label="Loading"></span>

    <p><img id="output" alt="Uploaded food image preview" /></p>

    <div id="opResult" aria-live="polite">Waiting for file upload</div>
    <h2>The approximate calorie value of this food is: <span id="calorie" aria-live="polite"></span> Kcal</h2>

<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1511.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/amazon-cognito-identity-js/6.1.1/amazon-cognito-identity.min.js"></script>

<script>
    const fileInput = document.getElementById('fileToUpload');
    const uploadLabel = document.getElementById('uploadLabel');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const opResult = document.getElementById('opResult');
    const calorieOutput = document.getElementById('calorie');
    const outputImage = document.getElementById('output');

    fileInput.addEventListener('change', () => {
        processImage();
    });

    // Accessibility: allow label to trigger file input on keyboard (space/enter)
    uploadLabel.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            fileInput.click();
        }
    });

    async function fetchCaloriesFromUSDA(foodName) {
        const apiKey = 'YOUR_API_KEY_HERE';
        const searchUrl = `https://api.nal.usda.gov/fdc/v1/foods/search?api_key=${apiKey}&query=${encodeURIComponent(foodName)}&pageSize=1`;

        try {
            const response = await fetch(searchUrl);
            const data = await response.json();

            if (data.foods && data.foods.length > 0) {
                const food = data.foods[0];
                const caloriesInfo = food.foodNutrients.find(n => n.nutrientName === "Energy");
                if (caloriesInfo) {
                    return caloriesInfo.value; // calories (usually per 100g)
                }
            }
            return null;
        } catch (error) {
            console.error("USDA API error:", error);
            return null;
        }
    }

    function showError(message) {
        opResult.innerHTML = `<p class="error">${message}</p>`;
        calorieOutput.textContent = "";
        outputImage.src = "";
    }

    function AnonLog(callback) {
        AWS.config.region = 'us-east-1';
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'Replace with your pool ID',
        });

        AWS.config.credentials.get(function(err) {
            if (err) {
                console.error("Cognito auth failed:", err);
                showError("Authentication failed. Please try again later.");
            } else {
                callback();
            }
        });
    }

    function saveLastResult(labels, calorie, imageSrc) {
        const data = {
            labels: labels,
            calorie: calorie,
            imageSrc: imageSrc,
            timestamp: Date.now()
        };
        localStorage.setItem('lastFoodCalciResult', JSON.stringify(data));
    }

    async function processImage() {
        const file = fileInput.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith('image/')) {
            showError("Invalid file type. Please upload an image.");
            return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showError("File too large. Please upload an image smaller than 5MB.");
            return;
        }

        // Clear previous results
        opResult.innerHTML = "Processing...";
        calorieOutput.textContent = "";
        loadingSpinner.style.display = 'inline-block';
        uploadLabel.setAttribute('aria-disabled', 'true');
        uploadLabel.style.pointerEvents = 'none';

        // Show image preview
        outputImage.src = URL.createObjectURL(file);

        AnonLog(() => {
            const reader = new FileReader();
            reader.onload = async function(e) {
                AWS.config.region = 'us-east-1';
                const rekognition = new AWS.Rekognition();

                const params = {
                    Image: { Bytes: new Uint8Array(e.target.result) },
                    MaxLabels: 5,
                    MinConfidence: 75
                };

                rekognition.detectLabels(params, async function(err, data) {
                    loadingSpinner.style.display = 'none';
                    uploadLabel.removeAttribute('aria-disabled');
                    uploadLabel.style.pointerEvents = 'auto';

                    if (err) {
                        console.error(err, err.stack);
                        showError("Error detecting labels. Please try again.");
                        return;
                    }

                    if (!data.Labels || data.Labels.length === 0) {
                        showError("No labels detected. Try another image.");
                        return;
                    }

                    let table = "<table><tr><th>Name of food</th><th>Confidence</th></tr>";
                    data.Labels.forEach(label => {
                        table += `<tr><td>${label.Name}</td><td>${label.Confidence.toFixed(2)}</td></tr>`;
                    });
                    table += "</table>";
                    opResult.innerHTML = table;

                    // Try to get calories from USDA API using the first label that returns data
                    let cal = 0;
                    for (let label of data.Labels) {
                        const calories = await fetchCaloriesFromUSDA(label.Name);
                        if (calories !== null) {
                            cal = Math.round(calories);
                            break;
                        }
                    }
                    if (cal === 0) {
                        cal = Math.floor(Math.random() * 100) + 75;
                    }

                    calorieOutput.textContent = cal;

                    // Save last result
                    saveLastResult(data.Labels, cal, outputImage.src);
                });

            };
            reader.onerror = () => {
                loadingSpinner.style.display = 'none';
                showError("Error reading file.");
                uploadLabel.removeAttribute('aria-disabled');
                uploadLabel.style.pointerEvents = 'auto';
            };
            reader.readAsArrayBuffer(file);
        });
    }

    // Load last results on page load
    window.onload = () => {
        const lastResult = localStorage.getItem('lastFoodCalciResult');
        if (lastResult) {
            const data = JSON.parse(lastResult);
            let table = "<table><tr><th>Name of food</th><th>Confidence</th></tr>";
            data.labels.forEach(label => {
                table += `<tr><td>${label.Name}</td><td>${label.Confidence.toFixed(2)}</td></tr>`;
            });
            table += "</table>";
            opResult.innerHTML = table;
            calorieOutput.textContent = data.calorie;
            outputImage.src = data.imageSrc;
        }
    };

</script>
</body>
</html>
